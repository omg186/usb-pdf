!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Mark=t()}(this,function(){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function e(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function n(e,t){return(n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function i(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function p(e,t){return new RegExp("^".concat(t,"$"),"i").test(e.nodeName)}function g(e){return/^(\s*)\n+(\s*)$/.test(e)}function h(e){return"string"==typeof e&&(e=e.replace(/\u200B/g,"")),e}function s(e,t){function n(e){return"---------- ".concat(t," ").concat(e?"start":"end"," ----------")}console.log(n(1)),console.log(e),console.log(n(0))}function v(e,t){var n,r;n=e,0!=(r=(r=t)||"").replace(/\s/g,"").length&&new RegExp(" "+r+" ").test(" "+n.className+" ")||(e.className=""==e.className?t:e.className+" "+t)}var t=function(){function n(e){o(this,n);var t=Object.assign({debug:!1},e);this.options=t}return e(n,[{key:"create",value:function(e,t){var n=t&&t.selection||window.getSelection();return this.tagName=e||"mark",this._create(n)}},{key:"_create",value:function(e){var t=[];if(0<e.rangeCount){var n=e.getRangeAt(0),r=n.startContainer,o=n.endContainer;if(r&&o)if(r===o||r.parentNode===o.parentNode){var a=this._createMarkElement();n.surroundContents(a),t.push(a)}else{var i=this._surroundCrossContents(n);t=t.concat(i)}else r?o||console.error("range.endContainer does not exist"):console.error("range.startContainer does not exist");e.removeAllRanges()}return t}},{key:"_getNewRange",value:function(e){var t=e.commonAncestorContainer,a=e.startContainer,i=e.endContainer,s=[],u=!1,l=!1;return function e(t){for(var n=t.childNodes,r=0;r<n.length;r++){var o=n[r];if(l)break;o===a&&(u=!0),o===i&&(l=!0),1===o.nodeType?o.contains(a)||o.contains(i)?e(o):u&&s.push(o):3===o.nodeType&&!g(o.nodeValue)&&u&&s.push(o)}}(t),{nodeList:s,startOffset:e.startOffset,endOffset:e.endOffset}}},{key:"_surroundCrossContents",value:function(e){var c=this,t=this.options,n=this._getNewRange(e),r=n.nodeList,f=n.startOffset,d=n.endOffset,p=r.length,g=[];return t.debug&&s(n,"newRange"),r.forEach(function(e,t){var n,r,o,a=e.parentNode,i=e.nodeValue,s=c._createMarkElement();if(0===t){if(3===e.nodeType){var u=e.nextSibling;s.innerText=i.substr(f),e.nodeValue=i.substr(0,f),u?a.insertBefore(s,u):a.appendChild(s),g.push(s)}}else if(t===p-1){if(3===e.nodeType){var l=e.previousSibling;s.innerText=i.substr(0,d),e.nodeValue=i.substr(d),l?(n=s,(o=(r=l).parentNode).lastChild==r?o.appendChild(n):o.insertBefore(n,r.nextSibling)):a.insertBefore(s,e),g.push(s)}}else 3===e.nodeType?(s.innerText=i,a.replaceChild(s,e)):(s.innerHTML=e.innerHTML,e.innerHTML="",e.appendChild(s)),g.push(s)}),g}},{key:"_createMarkElement",value:function(){var e=this.tagName;return document.createElement(e)}}]),n}();return function(){function r(e,t){var n;if(o(this,r),n=i(this,a(r).call(this,t)),null===e)throw new Error("TextareaElem does not exist");return n.options=Object.assign({tagName:"mark",debug:!1},n.options),n.textareaElem=e,n.innerData={points:[]},n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&n(e,t)}(r,t),e(r,[{key:"mark",value:function(e,t){if("exchange"===e){if(!(t&&t.points&&0<t.points.length))throw new Error("Required parameter options.points");this.innerData.points=t.points.sort(function(e,t){return e-t})}return this._mark(e)}},{key:"automark",value:function(u,l){var c=this;if(u&&0<u.length){var f=0;window.getSelection().removeAllRanges(),function e(){var t=u[f],n=c._getRangeData(t.startOffset,t.endOffset),r=window.getSelection(),o=window.document.createRange(),a=n.startRange,i=n.endRange;try{o.setStart(a.node,a.offset),o.setEnd(i.node,i.offset),r.addRange(o)}catch(e){console.error(e),console.error("".concat(JSON.stringify(t)))}var s=c._mark(t.type,t);l&&l.afterEach&&l.afterEach(s),++f<=u.length-1?e():l&&l.after&&l.after()}()}}},{key:"getContent",value:function(){var e=window.getSelection().getRangeAt(0),t="";return e&&(t=e.toString()),t.replace(/\n/g,"").trim()}},{key:"innerText",value:function(){var o="";return function e(t){for(var n=0;n<t.length;n++){var r=t[n];3!==r.nodeType||g(r.nodeValue)?1===r.nodeType&&(e(r.childNodes),p(r,"p")&&(o+="\n")):o+=r.nodeValue}}(this.textareaElem.childNodes),h(o)}},{key:"_mark",value:function(e,t){var n,r=window.getSelection();if(0<r.rangeCount){var o=r.getRangeAt(0),a=o.startContainer===o.endContainer&&o.startOffset===o.endOffset,i=this.create(this.options.tagName,r);0<i.length&&(t?n=t:((n=this._getData(i[0],i[i.length-1])).content=a?"缺漏":n.content,n.points="exchange"===e?this.innerData.points:[],n.key=function(){for(var e=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],t="",n=0;n<13;n++){t+=e[Math.round(Math.random()*(e.length-1))]}return t}(),n.type=a?"missing":e),this._setElems(i,n))}return n}},{key:"_setElems",value:function(e,t){if(e&&0<e.length){var n="exchange"===t.type?this._drawExchange(t):null;e.forEach(function(e){e.setAttribute("markkey",t.key),e.setAttribute("marktype",t.type),v(e,"mark-error mark-".concat(t.type)),n&&n(e)})}}},{key:"_drawExchange",value:function(c){var f=0,d=c&&c.points||this.innerData.points,p=c&&c.content.replace(/\n/g,"");return function e(t){for(var n=Array.prototype.slice.call(t.childNodes),r=0;r<n.length;r++){var o=n[r];if(3!==o.nodeType||g(o.nodeValue))1===o.nodeType&&e(o);else{for(var a=o.nodeValue,i=document.createDocumentFragment(),s=0;s<a.length;s++){var u="",l=document.createElement("i");l.innerHTML=a.charAt(s),0==f?u="left":f===p.length-1&&(u="right"),v(l,u),v(l,u=f==d[0]?"focus focus1":d[1]&&f===d[1]+1?"focus focus2":f<d[0]||d[1]&&f>d[1]+1?"top":"bottom"),l.setAttribute("marktype",c.type),i.appendChild(l),f++}o.parentNode.replaceChild(i,o)}}}}},{key:"_getData",value:function(i,s){var u=0,l="",c=null,f=null,d=null;return function e(t){for(var n=0;n<t.length;n++){var r=t[n];if(null!==f)break;if(3!==r.nodeType||g(r.nodeValue)){if(1===r.nodeType){if(r===i&&(c=u),r===s){var o=r.innerText;f=u+o.length,d=f-c,l+=o}e(r.childNodes),!f&&p(r,"p")&&(u++,l+="\n")}}else{var a=h(r.nodeValue);u+=a.length,l+=null!==c?a:""}}}(this.textareaElem.childNodes),{content:l.trim(),startOffset:c,endOffset:f,length:d}}},{key:"_getRangeData",value:function(u,l){var c=0,f=null,d=null;return function e(t){for(var n=0;n<t.length;n++){var r=t[n];if(null!==d)break;if(3!==r.nodeType||g(r.nodeValue))1===r.nodeType&&(e(r.childNodes),!d&&p(r,"p")&&c++);else{var o=c,a=h(r.nodeValue);if(c+=a.length,!f&&u<=c){var i=u-o;f={node:r,offset:i<0?0:i}}if(!d&&l<=c){var s=l-o;d={node:r,offset:s<0?0:s}}}}}(this.textareaElem.childNodes),{startRange:f,endRange:d}}}]),r}()});
